#!/usr/bin/env sh

echo "Dhpcd Cryptominer Detection Script by Akamai Threat Labs"

infected=false
ssh_key="ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQCuhPmv3xdhU7JbMoc/ecBTDxiGqFNKbe564p4aNT6JbYWjNwZ5z6E4iQQDQ0bEp7uBtB0aut0apqDF/SL7pN5ybh2X44aCwDaSEB6bJuJi0yMkZwIvenmtCA1LMAr2XifvGS/Ulac7Qh5vFzfw562cWC+IOI+LyQZAcPgr+CXphJhm8QQ+O454ItXurQX6oPlA2rNfF36fnxYss1ZvUYC80wWTi9k2+/XR3IoQXZHKCFsJiwyKO2CY+j" 

ps -aux | grep -q "dhpcd" && {
	infected=true
	echo "[*] Dhpcd process detected"
}

find /bin/* -maxdepth 1 -name dhpcd -type f | grep -q "dhpcd" && {
	infected=true
	echo "[*] Dhpcd binary path detected"
}

cat /etc/rc.local | grep -q "dhpcd" && {
	infected=true
	echo "[*] Dhpcd persistence method detected"
}

cat ~/.ssh/authorized_keys | grep -q $ssh_key && {
	infected=true
	echo "[*] Dhpcd backdoor method detected"
}

if $infected; then
	echo "[*] Dhpcd detected on this machine"
	exit 1
else
	echo "[*] There was no dhpcd activity detected on this machine"
	exit 0
fi